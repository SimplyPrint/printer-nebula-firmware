name: Check and Download Firmware Updates

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  update-firmware:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Check firmware version
      id: check_version
      run: |
        python -m pip install -r requirements.txt
        VERSION=$(python get-version.py)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Found version: $VERSION"

    - name: Check if release exists
      id: check_release
      run: |
        if gh release view "v${{ steps.check_version.outputs.version }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Download and create release
      if: steps.check_release.outputs.exists == 'false'
      run: |
        # Download dependencies
        sudo apt-get update
        sudo apt-get install openssl p7zip squashfs-tools wget whois
        
        # Download firmware
        chmod +x create.sh
        ./create.sh
        
        # Create release
        FIRMWARE_FILE="NEBULA_ota_img_V6.${{ steps.check_version.outputs.version }}.img"
        gh release create "V${{ steps.check_version.outputs.version }}" \
          --title "Firmware V${{ steps.check_version.outputs.version }}" \
          --notes "Firmware version ${{ steps.check_version.outputs.version }}" \
          "$FIRMWARE_FILE"
      env:
        CREALITY_VERSION: ${{ steps.check_version.outputs.version }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}